generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS
// ============================================================================

/// Representa um usuário do sistema (dono ou funcionário).
model User {
  id                   String              @id @default(uuid()) @map("id")
  createdAt            DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime            @updatedAt @map("updated_at") @db.Timestamptz
  email                String              @unique @map("email")
  name                 String              @map("name")
  phone                String              @map("phone")
  password             String              @map("password")
  role                 UserRole            @default(OWNER) @map("role")
  /// Timezone preferido do usuário (IANA timezone string, ex: "America/Sao_Paulo", "Europe/London")
  /// Se não configurado, frontend detecta automaticamente do navegador
  timezone             String?             @map("timezone") @db.VarChar(50)
  /// Status de verificação de email
  emailVerified        Boolean             @default(false) @map("email_verified")
  /// CPF ou documento criptografado (AES-256-GCM)
  document             String              @map("document") @db.VarChar(255)
  /// Indica se o usuário é fake/fictício (para testes)
  isFake               Boolean             @default(false) @map("is_fake")
  /// Status de conexão WhatsApp
  whatsappConnected    Boolean             @default(false) @map("whatsapp_connected")
  /// Telefone WhatsApp
  whatsappPhone        String?             @map("whatsapp_phone")
  /// Data de exclusão lógica.
  deletedAt            DateTime?           @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy            String?             @map("deleted_by")
  ownedEstablishments  Establishment[]
  createdPaymentOrders PaymentOrder[]      @relation("PaymentOrderCreatedBy")
  refreshTokens        RefreshToken[]
  createdSubscriptions Subscription[]
  tokens               Token[]
  userEstablishments   UserEstablishment[]
  appointments         Appointment[]
  transactions         Transaction[]
  paymentOrders        PaymentOrder[]      @relation("PaymentOrderUser")
  userProducts         UserProduct[]
  userServices         UserService[]
  workingHours         UserWorkingHours[]
  absencePeriods       UserAbsencePeriod[]

  @@index([email])
  @@index([deletedAt])
  @@map("users")
}

/// Representa um estabelecimento/barbearia.
model Establishment {
  id                 String                  @id @default(uuid()) @map("id")
  name               String                  @map("name")
  address            String                  @map("address")
  phone              String                  @map("phone")
  ownerId            String                  @map("owner_id")
  createdAt          DateTime                @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime                @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt          DateTime?               @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy          String?                 @map("deleted_by")
  appointments       Appointment[]
  closurePeriods     ClosurePeriod[]
  customers          EstablishmentCustomer[]
  products           EstablishmentProduct[]
  services           EstablishmentService[]
  owner              User                    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  userEstablishments UserEstablishment[]
  openingHours       OpeningHours[]
  subscriptions      Subscription[]

  // Note: Unique constraint on (ownerId, phone) is managed via partial unique index in migration
  // to allow soft delete - only enforces uniqueness when deletedAt IS NULL
  @@index([deletedAt])
  @@map("establishments")
}

// ============================================================================
// USER ESTABLISHMENT MODELS
// ============================================================================

/// Representa a relação entre usuário e estabelecimento (membros de estabelecimentos).
model UserEstablishment {
  id              String        @id @default(uuid()) @map("id")
  userId          String        @map("user_id")
  establishmentId String        @map("establishment_id")
  role            UserRole      @map("role")
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt       DateTime?     @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?       @map("deleted_by")
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@unique([userId, establishmentId])
  @@index([deletedAt])
  @@map("user_establishments")
}

/// Horários de trabalho dos usuários em estabelecimentos.
model UserWorkingHours {
  id        String    @id @default(uuid()) @map("id")
  dayOfWeek Int       @map("day_of_week")
  startTime String    @map("start_time")
  endTime   String    @map("end_time")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  userId    String    @map("user_id")
  /// Data de exclusão lógica.
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy String?   @map("deleted_by")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([deletedAt])
  @@map("user_working_hours")
}

/// Períodos de ausência dos usuários.
model UserAbsencePeriod {
  id        String    @id @default(uuid()) @map("id")
  reason    String?   @map("reason")
  startDate DateTime  @map("start_date") @db.Timestamptz
  endDate   DateTime  @map("end_date") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  userId    String    @map("user_id")
  /// Data de exclusão lógica.
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy String?   @map("deleted_by")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("user_absence_periods")
}

// ============================================================================
// CUSTOMERS MODELS
// ============================================================================

/// Clientes dos estabelecimentos.
model EstablishmentCustomer {
  id              String        @id @default(uuid()) @map("id")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  name            String        @map("name")
  email           String?       @map("email")
  phone           String?       @map("phone")
  establishmentId String        @map("establishment_id")
  /// Data de exclusão lógica.
  deletedAt       DateTime?     @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?       @map("deleted_by")
  appointments    Appointment[]
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@unique([establishmentId, email])
  @@unique([establishmentId, phone])
  @@index([deletedAt])
  @@map("establishment_customers")
}

// ============================================================================
// PRODUCTS & SERVICES MODELS
// ============================================================================

/// Produtos dos estabelecimentos.
model EstablishmentProduct {
  id               String            @id @default(uuid()) @map("id")
  name             String            @map("name")
  description      String?           @map("description")
  price            Int               @map("price")
  commission       Decimal           @map("commission") @db.Decimal(5, 4)
  stock            Int               @map("stock")
  establishmentId  String            @map("establishment_id")
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt        DateTime?         @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy        String?           @map("deleted_by")
  establishment    Establishment     @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  userProducts     UserProduct[]
  transactionItems TransactionItem[]

  @@unique([establishmentId, name])
  @@index([deletedAt])
  @@map("establishment_products")
}

/// Serviços dos estabelecimentos.
model EstablishmentService {
  id                  String               @id @default(uuid()) @map("id")
  name                String               @map("name")
  description         String?              @map("description")
  duration            Int                  @map("duration")
  price               Int                  @map("price")
  commission          Decimal              @map("commission") @db.Decimal(5, 4)
  establishmentId     String               @map("establishment_id")
  createdAt           DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime             @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt           DateTime?            @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy           String?              @map("deleted_by")
  appointmentServices AppointmentService[]
  establishment       Establishment        @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  userServices        UserService[]
  transactionItems    TransactionItem[]

  @@unique([establishmentId, name])
  @@index([deletedAt])
  @@map("establishment_services")
}

/// Produtos personalizados por usuário.
model UserProduct {
  id              String               @id @default(uuid()) @map("id")
  price           Int                  @map("price")
  commission      Decimal              @map("commission") @db.Decimal(5, 4)
  establishmentId String               @map("establishment_id")
  productId       String               @map("product_id")
  createdAt       DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime             @updatedAt @map("updated_at") @db.Timestamptz
  userId          String               @map("user_id")
  /// Data de exclusão lógica.
  deletedAt       DateTime?            @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?              @map("deleted_by")
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         EstablishmentProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, establishmentId, productId])
  @@index([deletedAt])
  @@map("user_products")
}

/// Serviços personalizados por usuário.
model UserService {
  id              String               @id @default(uuid()) @map("id")
  price           Int                  @map("price")
  commission      Decimal              @map("commission") @db.Decimal(5, 4)
  duration        Int                  @map("duration")
  establishmentId String               @map("establishment_id")
  serviceId       String               @map("service_id")
  createdAt       DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime             @updatedAt @map("updated_at") @db.Timestamptz
  userId          String               @map("user_id")
  /// Data de exclusão lógica.
  deletedAt       DateTime?            @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?              @map("deleted_by")
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  service         EstablishmentService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([userId, establishmentId, serviceId])
  @@index([deletedAt])
  @@map("user_services")
}

// ============================================================================
// APPOINTMENTS MODELS
// ============================================================================

/// Agendamentos de clientes.
model Appointment {
  id              String                @id @default(uuid()) @map("id")
  startTime       DateTime              @map("start_time") @db.Timestamptz
  endTime         DateTime              @map("end_time") @db.Timestamptz
  totalAmount     Int                   @map("total_amount")
  totalDuration   Int                   @map("total_duration")
  status          AppointmentStatus     @default(PENDING) @map("status")
  notes           String?               @map("notes")
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime              @updatedAt @map("updated_at") @db.Timestamptz
  customerId      String                @map("customer_id")
  userId          String                @map("user_id")
  establishmentId String                @map("establishment_id")
  /// Data de exclusão lógica.
  deletedAt       DateTime?             @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?               @map("deleted_by")
  services        AppointmentService[]
  customer        EstablishmentCustomer @relation(fields: [customerId], references: [id])
  establishment   Establishment         @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  user            User                  @relation(fields: [userId], references: [id])
  transaction     Transaction?

  @@index([deletedAt])
  @@map("appointments")
}

/// Serviços realizados em um agendamento.
model AppointmentService {
  id            String               @id @default(uuid()) @map("id")
  price         Int                  @map("price")
  duration      Int                  @map("duration")
  commission    Decimal              @map("commission") @db.Decimal(5, 4)
  appointmentId String               @map("appointment_id")
  serviceId     String               @map("service_id")
  /// Data de exclusão lógica.
  deletedAt     DateTime?            @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy     String?              @map("deleted_by")
  appointment   Appointment          @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service       EstablishmentService @relation(fields: [serviceId], references: [id])

  @@unique([appointmentId, serviceId])
  @@index([deletedAt])
  @@map("appointment_services")
}

// ============================================================================
// TRANSACTIONS MODELS
// ============================================================================

/// Transações financeiras.
model Transaction {
  id               String                @id @default(uuid()) @map("id")
  totalAmount      Int                   @map("total_amount")
  discount         Int                   @default(0) @map("discount")
  finalAmount      Int                   @map("final_amount")
  commissionAmount Int                   @map("commission_amount")
  paymentMethod    PaymentMethod         @map("payment_method")
  paymentStatus    PaymentStatus         @map("payment_status")
  notes            String?               @map("notes")
  transactionDate  DateTime              @default(now()) @map("transaction_date") @db.Timestamptz
  createdAt        DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime              @updatedAt @map("updated_at") @db.Timestamptz
  appointmentId    String?               @unique @map("appointment_id")
  customerId       String                @map("customer_id")
  userId           String                @map("user_id")
  establishmentId  String                @map("establishment_id")
  /// Data de exclusão lógica.
  deletedAt        DateTime?             @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy        String?               @map("deleted_by")
  items            TransactionItem[]
  appointment      Appointment?          @relation(fields: [appointmentId], references: [id])
  customer         EstablishmentCustomer @relation(fields: [customerId], references: [id])
  user             User                  @relation(fields: [userId], references: [id])

  @@index([deletedAt])
  @@map("transactions")
}

/// Itens de uma transação.
model TransactionItem {
  id            String                @id @default(uuid()) @map("id")
  itemType      ItemType              @map("item_type")
  quantity      Int                   @default(1) @map("quantity")
  unitPrice     Int                   @map("unit_price")
  totalPrice    Int                   @map("total_price")
  commission    Decimal               @map("commission") @db.Decimal(5, 4)
  createdAt     DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime              @updatedAt @map("updated_at") @db.Timestamptz
  transactionId String                @map("transaction_id")
  productId     String?               @map("product_id")
  serviceId     String?               @map("service_id")
  /// Data de exclusão lógica.
  deletedAt     DateTime?             @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy     String?               @map("deleted_by")
  product       EstablishmentProduct? @relation(fields: [productId], references: [id], onDelete: Restrict)
  service       EstablishmentService? @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  transaction   Transaction           @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("transaction_items")
}

/// Ordens de pagamento para membros.
model PaymentOrder {
  id              String        @id @default(uuid()) @map("id")
  totalAmount     Int           @map("total_amount")
  status          PaymentStatus @map("status")
  paymentMethod   PaymentMethod @map("payment_method")
  paymentDate     DateTime?     @map("payment_date") @db.Timestamptz
  periodStart     DateTime      @map("period_start") @db.Timestamptz
  periodEnd       DateTime      @map("period_end") @db.Timestamptz
  notes           String?       @map("notes")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  userId          String        @map("user_id")
  establishmentId String        @map("establishment_id")
  createdById     String        @map("created_by_id")
  /// Data de exclusão lógica.
  deletedAt       DateTime?     @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?       @map("deleted_by")
  createdBy       User          @relation("PaymentOrderCreatedBy", fields: [createdById], references: [id])
  user            User          @relation("PaymentOrderUser", fields: [userId], references: [id])

  @@index([deletedAt])
  @@map("payment_orders")
}

// ============================================================================
// SUBSCRIPTIONS MODELS
// ============================================================================

/// Planos de assinatura disponíveis.
model Plan {
  id            String         @id @default(uuid()) @map("id")
  name          String         @map("name")
  description   String?        @map("description")
  price         Int            @map("price")
  duration      Int            @map("duration")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt     DateTime?      @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy     String?        @map("deleted_by")
  subscriptions Subscription[]

  @@index([deletedAt])
  @@map("plans")
}

/// Assinaturas de planos por estabelecimentos.
model Subscription {
  id              String             @id @default(uuid()) @map("id")
  establishmentId String             @map("establishment_id")
  planId          String             @map("plan_id")
  createdById     String?            @map("created_by_id")
  startDate       DateTime           @map("start_date") @db.Timestamptz
  endDate         DateTime           @map("end_date") @db.Timestamptz
  status          SubscriptionStatus @default(PENDING) @map("status")
  paid            Boolean            @default(false) @map("paid")
  phone           String             @map("phone")
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt       DateTime?          @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?            @map("deleted_by")
  createdBy       User?              @relation(fields: [createdById], references: [id])
  establishment   Establishment      @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  plan            Plan               @relation(fields: [planId], references: [id])

  @@index([establishmentId])
  @@index([planId])
  @@index([createdById])
  @@index([deletedAt])
  @@map("subscriptions")
}

// ============================================================================
// AUTHENTICATION MODELS
// ============================================================================

/// Refresh tokens para autenticação de usuários.
model RefreshToken {
  id        String    @id @default(uuid()) @map("id")
  token     String    @unique @map("token")
  expiresAt DateTime  @map("expires_at") @db.Timestamptz
  revoked   Boolean   @default(false) @map("revoked")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  userId    String    @map("user_id")
  /// Data de exclusão lógica.
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy String?   @map("deleted_by")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("refresh_tokens")
}

/// Tokens genéricos para verificação de email, reset de senha, etc.
model Token {
  id        String    @id @default(uuid()) @map("id")
  type      TokenType @map("type")
  token     String    @map("token")
  expiresAt DateTime  @map("expires_at") @db.Timestamptz
  used      Boolean   @default(false) @map("used")
  metadata  Json?     @map("metadata")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  userId    String    @map("user_id")
  /// Data de exclusão lógica.
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy String?   @map("deleted_by")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([token])
  @@index([userId, type])
  @@index([deletedAt])
  @@map("tokens")
}

// ============================================================================
// CONFIGURATION MODELS
// ============================================================================

/// Horários de funcionamento dos estabelecimentos.
model OpeningHours {
  id              String        @id @default(uuid()) @map("id")
  dayOfWeek       Int           @map("day_of_week")
  openingTime     String        @map("opening_time")
  closingTime     String        @map("closing_time")
  establishmentId String        @map("establishment_id")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt       DateTime?     @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?       @map("deleted_by")
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@unique([establishmentId, dayOfWeek])
  @@index([deletedAt])
  @@map("opening_hours")
}

/// Períodos de fechamento dos estabelecimentos.
model ClosurePeriod {
  id              String        @id @default(uuid()) @map("id")
  startDate       DateTime      @map("start_date") @db.Timestamptz
  endDate         DateTime      @map("end_date") @db.Timestamptz
  reason          String?       @map("reason")
  establishmentId String        @map("establishment_id")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  /// Data de exclusão lógica.
  deletedAt       DateTime?     @map("deleted_at") @db.Timestamptz
  /// ID do usuário que realizou a exclusão.
  deletedBy       String?       @map("deleted_by")
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("closure_periods")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  OWNER
  ROOT
  RECEPTIONIST
  HAIRDRESSER
  BARBER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
  OTHER
}

enum ItemType {
  PRODUCT
  SERVICE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  WHATSAPP_VERIFICATION
  OTP
}
